<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "file://zonbook/docbookx.dtd"
[
  <!ENTITY % phrases-ddb-encrypt SYSTEM "shared/phrases-ddb-encrypt.ent">
  %phrases-ddb-encrypt;
  <!ENTITY % phrases-kms SYSTEM "shared/phrases-kms.ent">
  %phrases-kms;
  <!ENTITY % xinclude SYSTEM "file://AWSShared/common/xinclude.mod">
  %xinclude;
  <!ENTITY % phrases-shared SYSTEM "file://AWSShared/common/phrases-shared.ent">
  %phrases-shared;
 ]>
<section id="direct-kms-provider" role="topic">
  <info>
    <title id="direct-kms-provider.title">&direct-kms-long;</title>
    <titleabbrev>&direct-kms;</titleabbrev>
    <abstract>
      <para>Learn about the &direct-kms; in the &DDBEC; and how to use it in your &DDB;
        applications.</para>
    </abstract>
  </info>
  <para>The <emphasis role="italic">&direct-kms-long;</emphasis> (&direct-kms;) protects your table
    items under an <ulink url="&url-kms-dev;">&KMSlong;</ulink> (&KMS;) <ulink
      url="&url-kms-dev;concepts.html#master_keys">&CMKlong;</ulink> (&CMK;) that never
    leaves &KMS; unencrypted. This <link linkend="concept-material-provider">cryptographic materials
      provider</link> returns a unique encryption key and signing key for every table item. To do
    so, it calls &KMS; every time you encrypt or decrypt an item.</para>
  <para>If you're processing &DDB; items at a high frequency and large scale, you might exceed the
    &KMS; <ulink url="&url-kms-dev;limits.html#requests-per-second">requests-per-second
    limit</ulink>, causing processing delays. If you need to exceed the request-per-second limit and
    avoid delays, create a case in the <ulink url="&url-console-domain;support/home">AWS
    Support Center</ulink>. </para>
  <para>To use the &direct-kms;, the caller must have <ulink
    url="&url-support;knowledge-center/create-and-activate-aws-account/">an
    &AWS; account</ulink>, at least one &KMS; &CMK;, and permission to call the <ulink
    url="&url-kms-api;API_GenerateDataKey.html">GenerateDataKey</ulink> and <ulink
    url="&url-kms-api;API_Decrypt.html">Decrypt</ulink> operations on the &CMK;.</para>
 &kms-primary-key-note;
  <para>The &direct-kms; is one of several <link linkend="concept-material-provider"
    >cryptographic materials provider</link> (CMPs) that the &DDBEC; supports. For information about
    the other CMPs, see <xref linkend="crypto-materials-providers"
    endterm="crypto-materials-providers.title"/>.</para>
  <para><emphasis role="bold">For example code, see:</emphasis></para>
  <itemizedlist>
    <listitem>
      <para>Java: <ulink
        url="&url-ddbec-java;blob/master/examples/com/amazonaws/examples/AwsKmsEncryptedItem.java"
        >AwsKmsEncryptedItem</ulink></para>
    </listitem>
    <listitem>
      <para>Python: <ulink
        url="&url-ddbec-python;blob/master/examples/src/aws_kms_encrypted_table.py"
        >aws-kms-encrypted-table</ulink>, <ulink
        url="&url-ddbec-python;blob/master/examples/src/aws_kms_encrypted_item.py"
        >aws-kms-encrypted-item</ulink></para>
    </listitem>
  </itemizedlist>
  <para role="topiclist"><!-- TOPICLIST --></para>
  <section id="provider-kms-how-to-use">
    <info>
      <title id="provider-kms-how-to-use.title">How to use it</title>
    </info>
    <para>To create a &direct-kms;, specify an &KMS; <ulink
      url="&url-kms-dev;concepts.html#master_keys">&CMKlong;</ulink> (&CMK;) in your
      account.</para>
    <para>The value of the key ID parameter can be the <ulink
      url="&url-kms-dev;viewing-keys.html#find-cmk-id-arn">ID or Amazon Resource Name (ARN)</ulink>
      of the &CMK;, or an alias or alias ARN. Any values that are not specified in the ID, such as the
      region, must be available in the <ulink
      url="&url-cli-ug;cli-multiple-profiles.html">AWS named
      profile</ulink>. The &CMK; ARN provides all of the values that &KMS; needs.</para>
    <tablist>
      <tablistentry>
        <tabname>Java</tabname>
        <tabcontent><programlisting language="java">// Replace the example &CMK; ID and region with valid values for your application
final String cmkArn = '&example-key-arn-1;'
final String region = 'us-west-2'
      
final AWSKMS kms = AWSKMSClientBuilder.standard().withRegion(<replaceable>region</replaceable>).build();
final DirectKmsMaterialProvider cmp = new DirectKmsMaterialProvider(kms, <replaceable>cmkArn</replaceable>);</programlisting></tabcontent>
      </tablistentry>
      <tablistentry>
        <tabname>Python</tabname>
        <tabcontent><programlisting language="python">// Replace the example &CMK; ID with a valid value
aws_cmk_id = 'arn:aws:kms:us-west-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab'
aws_kms_cmp = AwsKmsCryptographicMaterialsProvider(key_id=<replaceable>aws_cmk_id</replaceable>)</programlisting></tabcontent>
      </tablistentry>
    </tablist>
  </section>
  <section id="provider-kms-how-it-works">
    <info>
      <title id="provider-kms-how-it-works.title">How it works</title>
    </info>
    <para>The &direct-kms; returns encryption and signing keys that are protected by an &KMS;
      &CMK; that you specify, as shown in the following diagram.</para>
    <mediaobject>
      <imageobject>
        <imagedata fileref="images/directKMS.png" format="PNG" scale="75"/>
      </imageobject>
      <textobject>
        <phrase>The input, processing, and output of the &direct-kms; in the &DDBEC;</phrase>
      </textobject>
    </mediaobject>
    <itemizedlist>
      <listitem>
        <para>To generate encryption materials, the &direct-kms; asks &KMS; to <ulink
          url="&url-kms-api;API_GenerateDataKey.html">generate a unique data key</ulink> for each
          item using a <ulink url="&url-kms-dev;concepts.html#master_keys">&CMKlong;</ulink> (&CMK;) that you specify. It derives encryption and signing keys for the item
          from the plaintext copy of the <ulink url="&url-kms-dev;concepts.html#data-keys">data
          key</ulink>, and then returns the encryption and signing keys, along with the encrypted
          data key, which is stored in the <link linkend="material-description">material description
          attribute</link> of the item. </para>
        <para>The item encryptor uses the encryption and signing keys and removes them from memory
          as soon as possible. Only the encrypted copy of the data key from which they were derived
          is saved in the encrypted item.</para>
      </listitem>
      <listitem>
        <para>To generate decryption materials, the &direct-kms; asks &KMS; to decrypt the
          encrypted data key. Then, it derives verification and signing keys from the plaintext data
          key, and returns them to the item encryptor.</para>
        <para>The item encryptor verifies the item and, if verification succeeds, decrypts the
          encrypted values. Then, it removes the keys from memory as soon as possible.</para>
      </listitem>
    </itemizedlist>
    <para role="topiclist"><!-- TOPICLIST --></para>
    <section id="direct-kms-get-encryption-materials">
      <info>
        <title id="direct-kms-get-encryption-materials.title">Get encryption materials</title>
      </info>
      <para>This section describes in detail the inputs, outputs, and processing of the Direct KMS
        Provider when it receives a request for encryption materials from the <link
        linkend="item-encryptor">item encryptor</link>.</para>
      <para><emphasis role="bold">Input </emphasis> (from the application)</para>
      <itemizedlist>
        <listitem>
          <para>The key ID of an &KMS; &CMK;. </para>
        </listitem>
      </itemizedlist>
      <para><emphasis role="bold">Input</emphasis> (from the item encryptor)</para>
      <itemizedlist>
        <listitem>
          <para><link linkend="encryption-context">&DDB; encryption context</link></para>
        </listitem>
      </itemizedlist>
      <para><emphasis role="bold">Output</emphasis> (to the item encryptor)</para>
      <itemizedlist>
        <listitem>
          <para>Encryption key (plaintext)</para>
        </listitem>
        <listitem>
          <para>Signing key</para>
        </listitem>
        <listitem>
          <para>In <link linkend="material-description">actual material description</link>: These
            values are saved in the material description attribute that the client adds to the
            item.</para>
          <itemizedlist>
            <listitem>
              <para>amzn-ddb-env-key: Base64-encoded data key encrypted by the &KMS; &CMK;</para>
            </listitem>
            <listitem>
              <para>amzn-ddb-env-alg: Encryption algorithm, by default <ulink
                  url="https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines/archived-crypto-projects/aes-development">AES/256</ulink></para>
            </listitem>
            <listitem>
              <para>amzn-ddb-sig-alg: Signing algorithm, by default, <ulink url="https://en.wikipedia.org/wiki/HMAC">HmacSHA256/256</ulink></para>
            </listitem>
            <listitem>
              <para>amzn-ddb-wrap-alg: kms</para>
            </listitem>
          </itemizedlist>
        </listitem>
      </itemizedlist>
      <para><emphasis role="bold">Processing</emphasis></para>
      <orderedlist>
        <listitem>
          <para>The Direct KMS provider sends &KMS; a request to use the specified &CMK; to <ulink
            url="&url-kms-api;API_GenerateDataKey.html"
            >generate a unique data key</ulink> for the item. The operation returns a plaintext key
            and a copy that is encrypted under the &CMK;. This is known as the <emphasis role="italic"
            >initial key material</emphasis>.</para>
          <para>The request includes the following  values in plaintext in <ulink
            url="&url-kms-dev;concepts.html#encrypt_context"
            >&KMS; encryption context</ulink>. These non-secret values are cryptographically bound
            to the encrypted object, so the same encryption context is required on decrypt. You can
            use these values to identify the call to &KMS; in <ulink
            url="&url-kms-dev;monitoring-overview.html"
            >&CTlong; logs</ulink>.</para>
          <itemizedlist>
            <listitem>
              <para>amzn-ddb-env-alg &endash; Encryption algorithm, by default AES/256</para>
            </listitem>
            <listitem>
              <para>amzn-ddb-sig-alg &endash; Signing algorithm, by default HmacSHA256/256</para>
            </listitem>
            <listitem>
              <para>(Optional) aws-kms-table &endash; <replaceable>table name</replaceable></para>
            </listitem>
            <listitem>
              <para>(Optional) <replaceable>partition key name</replaceable> &endash;
                <replaceable>partition key value</replaceable> (binary values are
                Base64-encoded)</para>
            </listitem>
            <listitem>
              <para>(Optional) <replaceable>sort key name</replaceable> &endash; <replaceable>sort
                key value</replaceable> (binary values are Base64-encoded)</para>
            </listitem>
          </itemizedlist>
          <para>The Direct KMS provider gets the values for the &KMS; encryption context from the
            <link linkend="encryption-context">&DDB; encryption context</link> for the item. If the
            &DDB; encryption context doesn't include a value, such as the table name, that
            name-value pair is omitted from the &KMS; encryption context.</para>
          
        </listitem>
        <listitem>
          <para>The &direct-kms; derives a symmetric encryption key and a signing key from
            the data key. By default, it uses <ulink url="https://en.wikipedia.org/wiki/SHA-2"
            >Secure Hash Algorithm (SHA) 256</ulink> and <ulink
            url="https://tools.ietf.org/html/rfc5869">RFC5869 HMAC-based Key Derivation
            Function</ulink> to derive a 256-bit AES symmetric encryption key and a 256-bit
            HMAC-SHA-256 signing key. </para>
        </listitem>
        <listitem>
          <para>The &direct-kms; returns the output to the item encryptor.</para>
        </listitem>
        <listitem>
          <para>The item encryptor uses the encryption key to encrypt the specified attributes and
            the signing key to sign them, using the algorithms specified in the actual material
            description. It removes the plaintext keys from memory as soon as possible.</para>
        </listitem>
      </orderedlist>
    </section>

    <section id="direct-kms-get-decryption-materials">
      <info>
        <title id="direct-kms-get-decryption-materials.title">Get decryption materials</title>
      </info>
      <para>This section describes in detail the inputs, outputs, and processing of the Direct KMS
        Provider when it receives a request for decryption materials from the <link
        linkend="item-encryptor">item encryptor</link>.</para>
      <para><emphasis role="bold">Input </emphasis> (from the application)</para>
      <itemizedlist>
        <listitem>
          <para>The key ID of an &KMS; &CMK;. </para>
          <para>The value of the key ID can be the ID or Amazon Resource Name (ARN) of the &CMK;, or
            an alias or alias ARN, provided that any values that are omitted, such as the region,
            are available in the <ulink
            url="&url-cli-ug;cli-multiple-profiles.html">AWS
            named profile</ulink>. The &CMK; ARN provides all of the values that &KMS; needs.</para>
        </listitem>
      </itemizedlist>
      <para><emphasis role="bold">Input</emphasis> (from the item encryptor)</para>
      <itemizedlist>
        <listitem>
          <para>A copy of the <link linkend="encryption-context">&DDB; encryption context</link>
            that contains the contents of the material description attribute.</para>
        </listitem>
      </itemizedlist>
      <para><emphasis role="bold">Output</emphasis> (to the item encryptor)</para>
      <itemizedlist>
        <listitem>
          <para>Encryption key (plaintext)</para>
        </listitem>
        <listitem>
          <para>Signing key</para>
        </listitem>
      </itemizedlist>
      <para><emphasis role="bold">Processing</emphasis></para>
      <orderedlist>
        <listitem>
          <para>The Direct KMS provider gets the encrypted data key from the material description
            attribute in the encrypted item. </para>
        </listitem>
        <listitem>
          <para>It asks &KMS; to use the specified &CMK; to <ulink
            url="&url-kms-api;API_GenerateDataKey.html"
            >decrypt</ulink> the encrypted data key. The operation returns a plaintext key.</para>
          <para>This request must use the same <ulink
            url="&url-kms-dev;concepts.html#encrypt_context"
            >&KMS; encryption context</ulink> that was used to generate and encrypt the data
            key.</para>
          <itemizedlist>
            <listitem>
              <para>aws-kms-table &endash; <replaceable>table name</replaceable></para>
            </listitem>
            <listitem>
              <para><replaceable>partition key name</replaceable> &endash; <replaceable>partition
                key value</replaceable> (binary values are Base64-encoded)</para>
            </listitem>
            <listitem>
              <para>(Optional) <replaceable>sort key name</replaceable> &endash; <replaceable>sort
                key value</replaceable> (binary values are Base64-encoded)</para>
            </listitem>
            <listitem>
              <para>amzn-ddb-env-alg &endash; Encryption algorithm, by default AES/256</para>
            </listitem>
            <listitem>
              <para>amzn-ddb-sig-alg &endash; Signing algorithm, by default HmacSHA256/256</para>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para>The &direct-kms; uses <ulink url="https://en.wikipedia.org/wiki/SHA-2">Secure
            Hash Algorithm (SHA) 256</ulink> and <ulink url="https://tools.ietf.org/html/rfc5869"
            >RFC5869 HMAC-based Key Derivation Function</ulink> to derive a 256-bit AES symmetric
            encryption key and a 256-bit HMAC-SHA-256 signing key from the data key. </para>
        </listitem>
        <listitem>
          <para>The &direct-kms; returns the output to the item encryptor.</para>
        </listitem>
        <listitem>
          <para>The item encryptor uses the signing key to verify the item. If it succeeds, it uses
            the symmetric encryption key to decrypt the encrypted attribute values. These operations
            use the encryption and signing algorithms specified in the actual material description.
            The item encryptor removes the plaintext keys from memory as soon as possible.</para>
        </listitem>
      </orderedlist>
    </section>
  </section>
</section>
